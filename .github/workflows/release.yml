# FILE: .github/workflows/release.yml
name: Release Automation

# Releases trigger automatically on SemVer tags
on:
  push:
    tags:
      - 'v*'

# Needs write perms to publish GitHub Releases
permissions:
  contents: write
  packages: read

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Keep build tooling cached between release attempts
      - name: Cache pip downloads
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: release-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'requirements*.txt') }}
          restore-keys: |
            release-${{ runner.os }}-

      # Install packaging stack for wheel/sdist creation
      - name: Install packaging tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build wheel

      - name: Build distribution artifacts
        run: python -m build

      # Produce a minimal changelog straight from Git history
      - name: Generate changelog
        id: changelog
        env:
          CURRENT_TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          mkdir -p release
          PREV_TAG=$(git tag --sort=-creatordate | grep -Fvx "${CURRENT_TAG}" | head -n 1)
          {
            echo "# Release ${CURRENT_TAG}"
            echo
            if [ -z "$PREV_TAG" ]; then
              git log --pretty=format:'- %s (%h)'
            else
              git log "$PREV_TAG".."${CURRENT_TAG}" --pretty=format:'- %s (%h)'
            fi
          } > release/CHANGELOG.md
          echo "file=release/CHANGELOG.md" >> "$GITHUB_OUTPUT"

      - name: Capture Docker metadata
        id: docker_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=sha
            type=ref,event=tag
            type=raw,value=latest

      - name: Write Docker metadata file
        run: |
          mkdir -p release
          echo "${{ steps.docker_meta.outputs.tags }}" > release/docker-metadata.txt

      # Publish build outputs for provenance/debugging
      - name: Upload release assets
        uses: actions/upload-artifact@v6
        with:
          name: release-assets
          path: |
            dist/*
            ${{ steps.changelog.outputs.file }}
            release/docker-metadata.txt

      # Create (or update) the GitHub Release with binaries + metadata
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body_path: ${{ steps.changelog.outputs.file }}
          files: |
            dist/*
            release/docker-metadata.txt
