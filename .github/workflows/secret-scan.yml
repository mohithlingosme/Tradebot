name: Secret Scan

on:
  push:
    branches: [dev, staging, main]
  pull_request:
    branches: [dev, staging, main]
  schedule:
    # Run weekly on Sunday at 2am UTC
    - cron: '0 2 * * 0'

jobs:
  gitleaks:
    name: Gitleaks Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Configure Gitleaks to scan for common secrets
          # You can customize rules in .gitleaks.toml if needed
          GITLEAKS_CONFIG_PATH: .gitleaks.toml

  trufflehog:
    name: TruffleHog Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          # Exit code 0 if no secrets found, 1 if secrets found
          extra_args: --only-verified

  secret-scanned:
    name: Mark Secrets as Scanned
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog]
    if: always()
    steps:
      - name: Check scan results
        run: |
          echo "Secret scanning completed!"
          # This is a placeholder for any post-scan actions
          # like notifying a security team or creating issues
          if [ "${{ needs.gitleaks.result }}" == "failure" ] || [ "${{ needs.trufflehog.result }}" == "failure" ]; then
            echo "⚠️ WARNING: Potential secrets detected!"
            echo "Please review the secret scan results above."
            # Uncomment the following line to fail the workflow if secrets are found
            # exit 1
          fi
