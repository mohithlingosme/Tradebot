# FILE: .github/workflows/nightly-tests.yml
name: Nightly Tests

# Fire nightly plus ad-hoc manual runs
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

# Tests only read from the repository
permissions:
  contents: read

jobs:
  nightly:
    name: Full regression suite
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      PYTHONWARNINGS: default
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Keep dependency installation snappy even for long running suites
      - name: Cache pip downloads
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: nightly-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'requirements*.txt') }}
          restore-keys: |
            nightly-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then
            python -m pip install -r requirements-dev.txt
          fi
          python -m pip install pytest pytest-cov

      # Execute the most thorough suite (with coverage + durations)
      - name: Run full pytest suite
        run: |
          mkdir -p reports
          pytest --maxfail=1 --durations=25 --junitxml=reports/nightly.xml --cov=src --cov-report=xml:reports/nightly-coverage.xml

      - name: Upload nightly artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-pytests
          path: reports/
